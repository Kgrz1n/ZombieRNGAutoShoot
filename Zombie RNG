local player = game.Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ZombiesFolder = workspace:WaitForChild("Zombies")
local ServerZombies = workspace:WaitForChild("ServerZombies")
local Camera = workspace.CurrentCamera

for _, name in pairs({"autosolver_euler", "hitbox_debugger_gui", "object_explorer_gui"}) do
    local old = game:GetService("CoreGui"):FindFirstChild(name) or player.PlayerGui:FindFirstChild(name)
    if old then old:Destroy() end
end

-- ==================== CONFIGURAÇÕES AUTO FARM ====================
local isAutoFarmEnabled = false
local isBossDetectionEnabled = true
local isAutoCollectEnabled = true
local isInfiniteShotEnabled = false
local magnetRange = 100
local safeUndergroundDepth = 10
local autoFarmMode = "underground"
local currentRound = 0
local isBossRound = false
local lastShakeTime = 0

-- ==================== VARIÁVEIS ORIGINAIS ====================
local isLockOnActive = false
local isUndergroundCameraLock = false -- NOVO: câmera de baixo para cima
local isShowHitboxEnabled = false
local isAutoShootEnabled = false
local isWallCheckEnabled = true
local isLowGraphicsEnabled = false
local isReduceMotionEnabled = false
local isFlyEnabled = false
local isNoclipEnabled = false
local isUndergroundEnabled = false
local lockSmoothness = 0.2
local shootSpeed = 0.15
local stickyTime = 2.0
local flySpeed = 50
local maxLockDistance = 50
local undergroundDepth = 15
local lockKey = Enum.KeyCode.T
local priorityMode = "closest"
local TARGET_PART_NAME = "Head"
local currentLockedTarget = nil
local targetLockTime = 0
local isBinding = false
local isMinimized = false
local lastShootTime = 0
local originalCameraSubject = nil

local flyConnection
local noclipConnection
local autoFarmConnection

-- ==================== FUNÇÕES AUTO FARM ====================

local function detectScreenShake()
    local currentPos = Camera.CFrame.Position
    task.wait(0.1)
    local newPos = Camera.CFrame.Position
    local distance = (currentPos - newPos).Magnitude
    
    if distance > 0.5 and tick() - lastShakeTime > 5 then
        lastShakeTime = tick()
        print("[AUTO FARM] Boss detectado por tremida de tela!")
        isBossRound = true
        return true
    end
    return false
end

local function isBossZombie(zombie)
    if not zombie then return false end
    local name = zombie.Name:lower()
    return name:find("boss") ~= nil
end

local function findBoss()
    for _, zombie in pairs(ZombiesFolder:GetChildren()) do
        if isBossZombie(zombie) then
            local hitbox = zombie:FindFirstChild(TARGET_PART_NAME)
            if hitbox then
                return hitbox
            end
        end
    end
    return nil
end

local function detectRoundFromUI()
    local playerGui = player:WaitForChild("PlayerGui")
    
    for _, gui in pairs(playerGui:GetDescendants()) do
        if gui:IsA("TextLabel") then
            local text = gui.Text:lower()
            if text:find("round") or text:find("wave") then
                local number = tonumber(text:match("%d+"))
                if number then
                    currentRound = number
                    isBossRound = (number % 10 == 0)
                    return number
                end
            end
        end
    end
    return currentRound
end

local function findNearbyDrops()
    local char = player.Character
    if not char then return {} end
    local pRoot = char:FindFirstChild("HumanoidRootPart")
    if not pRoot then return {} end
    
    local drops = {}
    local dropNames = {"chestspawn", "mysterybox", "door", "rewardchest", "ammobox", "bombchest", "chest", "reward", "loot", "drop", "item", "box", "mystery"}
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") or obj:IsA("Part") then
            local name = obj.Name:lower()
            for _, dropName in pairs(dropNames) do
                if name:find(dropName) then
                    local pos = obj:IsA("Model") and obj:GetPivot().Position or obj.Position
                    local dist = (pRoot.Position - pos).Magnitude
                    
                    if dist <= magnetRange then
                        table.insert(drops, {object = obj, distance = dist})
                    end
                    break
                end
            end
        end
    end
    
    return drops
end

local function activateMagnet()
    if not isAutoCollectEnabled then return end
    
    local drops = findNearbyDrops()
    if #drops == 0 then return end
    
    local char = player.Character
    if not char then return end
    local pRoot = char:FindFirstChild("HumanoidRootPart")
    if not pRoot then return end
    
    table.sort(drops, function(a, b) return a.distance < b.distance end)
    
    for i, drop in pairs(drops) do
        if i > 3 then break end
        local pos = drop.object:IsA("Model") and drop.object:GetPivot().Position or drop.object.Position
        pRoot.CFrame = CFrame.new(pos + Vector3.new(0, 3, 0))
        task.wait(0.2)
        print("[AUTO FARM] Coletado:", drop.object.Name)
    end
end

local function enableInfiniteShot()
    isWallCheckEnabled = false
    maxLockDistance = 999999
end

local function ensureSafePosition()
    if not isAutoFarmEnabled then return end
    
    local char = player.Character
    if not char then return end
    local pRoot = char:FindFirstChild("HumanoidRootPart")
    if not pRoot then return end
    
    if autoFarmMode == "underground" then
        if not isUndergroundEnabled then
            isUndergroundEnabled = true
            undergroundDepth = safeUndergroundDepth
            toggleUnderground(true)
        end
    elseif autoFarmMode == "fly" then
        if not isFlyEnabled then
            isFlyEnabled = true
            toggleFly(true)
        end
        if pRoot.Position.Y < 50 then
            pRoot.CFrame = pRoot.CFrame + Vector3.new(0, 50, 0)
        end
    end
end

local function startAutoFarm()
    if autoFarmConnection then
        autoFarmConnection:Disconnect()
    end
    
    print("[AUTO FARM] Sistema iniciado!")
    
    ensureSafePosition()
    
    if isInfiniteShotEnabled then
        enableInfiniteShot()
    end
    
    isUndergroundCameraLock = true
    isLockOnActive = false
    isAutoShootEnabled = true
    
    autoFarmConnection = RunService.Heartbeat:Connect(function()
        if not isAutoFarmEnabled then return end
        
        detectRoundFromUI()
        
        if isBossDetectionEnabled and isBossRound then
            local boss = findBoss()
            if boss then
                currentLockedTarget = boss
                priorityMode = "boss"
            else
                isBossRound = false
                priorityMode = "closest"
            end
        end
        
        if isAutoCollectEnabled and tick() % 3 < 0.1 then
            task.spawn(activateMagnet)
        end
        
        ensureSafePosition()
    end)
end

local function stopAutoFarm()
    if autoFarmConnection then
        autoFarmConnection:Disconnect()
        autoFarmConnection = nil
    end
    
    isLockOnActive = false
    isUndergroundCameraLock = false
    isAutoShootEnabled = false
    
    print("[AUTO FARM] Sistema parado!")
end

-- ==================== EXPLORADOR DE OBJETOS ====================

local function createObjectExplorer()
    local explorerGui = Instance.new("ScreenGui", player.PlayerGui)
    explorerGui.Name = "object_explorer_gui"
    
    local frame = Instance.new("Frame", explorerGui)
    frame.Size = UDim2.new(0, 400, 0, 500)
    frame.Position = UDim2.new(0.5, -200, 0.5, -250)
    frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    frame.BorderSizePixel = 0
    frame.Active = true
    frame.Draggable = true
    
    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1, 0, 0, 30)
    title.Text = "OBJECT EXPLORER"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 14
    title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    title.BorderSizePixel = 0
    
    local closeBtn = Instance.new("TextButton", frame)
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -30, 0, 0)
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 16
    closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    closeBtn.BorderSizePixel = 0
    closeBtn.MouseButton1Click:Connect(function()
        explorerGui:Destroy()
    end)
    
    local scroll = Instance.new("ScrollingFrame", frame)
    scroll.Size = UDim2.new(1, -20, 1, -90)
    scroll.Position = UDim2.new(0, 10, 0, 40)
    scroll.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
    scroll.BorderSizePixel = 0
    scroll.ScrollBarThickness = 6
    
    local scanBtn = Instance.new("TextButton", frame)
    scanBtn.Size = UDim2.new(0, 180, 0, 35)
    scanBtn.Position = UDim2.new(0.5, -90, 1, -45)
    scanBtn.Text = "SCAN WORKSPACE"
    scanBtn.TextColor3 = Color3.new(1, 1, 1)
    scanBtn.Font = Enum.Font.GothamBold
    scanBtn.TextSize = 12
    scanBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 50)
    scanBtn.BorderSizePixel = 0
    
    local yPos = 0
    scanBtn.MouseButton1Click:Connect(function()
        for _, child in pairs(scroll:GetChildren()) do
            if child:IsA("TextLabel") then
                child:Destroy()
            end
        end
        
        yPos = 0
        
        local foundObjects = {}
        
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj:IsA("Model") or obj:IsA("Part") then
                local name = obj.Name:lower()
                if name:find("chest") or name:find("reward") or name:find("portal") or 
                   name:find("passage") or name:find("door") or name:find("loot") or
                   name:find("drop") or name:find("item") or name:find("box") or
                   name:find("boss") or name:find("mystery") or name:find("ammo") then
                    table.insert(foundObjects, obj.Name .. " | " .. obj.ClassName)
                end
            end
        end
        
        local unique = {}
        for _, name in pairs(foundObjects) do
            unique[name] = true
        end
        
        for name, _ in pairs(unique) do
            local label = Instance.new("TextLabel", scroll)
            label.Size = UDim2.new(1, -10, 0, 25)
            label.Position = UDim2.new(0, 5, 0, yPos)
            label.Text = name
            label.TextColor3 = Color3.fromRGB(200, 200, 200)
            label.Font = Enum.Font.Code
            label.TextSize = 11
            label.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
            label.BorderSizePixel = 0
            label.TextXAlignment = Enum.TextXAlignment.Left
            
            yPos = yPos + 27
        end
        
        scroll.CanvasSize = UDim2.new(0, 0, 0, yPos)
        
        print("[EXPLORER] Encontrados " .. yPos/27 .. " objetos relevantes!")
    end)
end

-- ==================== FUNÇÕES ORIGINAIS ====================

local function getServerData(zombieClient)
    if not zombieClient then return nil end
    local targetIdStr = tostring(zombieClient.Name)
    for _, serverModel in pairs(ServerZombies:GetChildren()) do
        local success, idValue = pcall(function() return serverModel.id end)
        if not success or not idValue then
            idValue = serverModel:GetAttribute("id") or (serverModel:FindFirstChild("id") and serverModel.id.Value)
        end
        if idValue and tostring(idValue) == targetIdStr then
            return serverModel:FindFirstChildOfClass("Humanoid"), serverModel:FindFirstChild("HumanoidRootPart"), serverModel
        end
    end
    return nil
end

local function toggleFly(enabled)
    local char = player.Character
    if not char then return end
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    local rootPart = char:FindFirstChild("HumanoidRootPart")
    
    if enabled then
        local bodyVelocity = Instance.new("BodyVelocity", rootPart)
        bodyVelocity.Name = "FlyVelocity"
        bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        
        local bodyGyro = Instance.new("BodyGyro", rootPart)
        bodyGyro.Name = "FlyGyro"
        bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
        bodyGyro.P = 9e4
        bodyGyro.CFrame = rootPart.CFrame
        
        flyConnection = RunService.Heartbeat:Connect(function()
            if not isFlyEnabled then return end
            
            local moveDirection = Vector3.new(0, 0, 0)
            local cam = Camera.CFrame
            
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                moveDirection = moveDirection + (cam.LookVector * flySpeed)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                moveDirection = moveDirection - (cam.LookVector * flySpeed)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                moveDirection = moveDirection - (cam.RightVector * flySpeed)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                moveDirection = moveDirection + (cam.RightVector * flySpeed)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                moveDirection = moveDirection + Vector3.new(0, flySpeed, 0)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
                moveDirection = moveDirection - Vector3.new(0, flySpeed, 0)
            end
            
            if bodyVelocity then
                bodyVelocity.Velocity = moveDirection
            end
            if bodyGyro then
                bodyGyro.CFrame = cam
            end
        end)
        
    else
        if flyConnection then
            flyConnection:Disconnect()
            flyConnection = nil
        end
        
        if rootPart then
            local fv = rootPart:FindFirstChild("FlyVelocity")
            local fg = rootPart:FindFirstChild("FlyGyro")
            if fv then fv:Destroy() end
            if fg then fg:Destroy() end
        end
    end
end

local function toggleUnderground(enabled)
    local char = player.Character
    if not char then return end
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    local rootPart = char:FindFirstChild("HumanoidRootPart")
    local head = char:FindFirstChild("Head")
    
    if not rootPart or not head then return end
    
    if enabled then
        local cameraPart = Instance.new("Part")
        cameraPart.Name = "UndergroundCameraPart"
        cameraPart.Anchored = true
        cameraPart.CanCollide = false
        cameraPart.Transparency = 1
        cameraPart.Size = Vector3.new(1, 1, 1)
        cameraPart.CFrame = head.CFrame
        cameraPart.Parent = workspace
        
        originalCameraSubject = Camera.CameraSubject
        Camera.CameraSubject = cameraPart
        
        local undergroundConnection
        undergroundConnection = RunService.RenderStepped:Connect(function()
            if not isUndergroundEnabled then
                if undergroundConnection then
                    undergroundConnection:Disconnect()
                end
                return
            end
            
            if cameraPart and cameraPart.Parent then
                local currentPos = rootPart.Position
                cameraPart.CFrame = CFrame.new(
                    currentPos.X,
                    currentPos.Y + undergroundDepth,
                    currentPos.Z
                )
            end
        end)
        
        rootPart.CFrame = rootPart.CFrame - Vector3.new(0, undergroundDepth, 0)
        
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
        
    else
        local cameraPart = workspace:FindFirstChild("UndergroundCameraPart")
        if cameraPart then
            cameraPart:Destroy()
        end
        
        if originalCameraSubject then
            Camera.CameraSubject = originalCameraSubject
        else
            Camera.CameraSubject = humanoid
        end
        
        rootPart.CFrame = rootPart.CFrame + Vector3.new(0, undergroundDepth, 0)
        
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                part.CanCollide = true
            end
        end
    end
end

local function toggleNoclip(enabled)
    local char = player.Character
    if not char then return end
    
    if enabled then
        noclipConnection = RunService.Stepped:Connect(function()
            if not isNoclipEnabled then return end
            
            for _, part in pairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end)
        
    else
        if noclipConnection then
            noclipConnection:Disconnect()
            noclipConnection = nil
        end
        
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = true
            end
        end
    end
end

local function toggleReduceMotion(enabled)
    if enabled then
        for _, zombie in pairs(ZombiesFolder:GetChildren()) do
            local humanoid = zombie:FindFirstChildOfClass("Humanoid")
            if humanoid then
                local animator = humanoid:FindFirstChildOfClass("Animator")
                if animator then
                    for _, track in pairs(animator:GetPlayingAnimationTracks()) do
                        track:Stop()
                        track:Destroy()
                    end
                    animator:Destroy()
                end
                
                humanoid.WalkSpeed = 0
                humanoid.JumpPower = 0
                humanoid.AutoRotate = false
                humanoid.PlatformStand = true
            end
            
            for _, part in pairs(zombie:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.Anchored = true
                    part.CanCollide = false
                    part.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                    part.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                end
            end
            
            for _, obj in pairs(zombie:GetDescendants()) do
                if obj:IsA("Motor6D") or obj:IsA("Weld") or obj:IsA("WeldConstraint") then
                    obj:Destroy()
                end
            end
        end
        
        for _, zombie in pairs(ServerZombies:GetChildren()) do
            local humanoid = zombie:FindFirstChildOfClass("Humanoid")
            if humanoid then
                local animator = humanoid:FindFirstChildOfClass("Animator")
                if animator then
                    for _, track in pairs(animator:GetPlayingAnimationTracks()) do
                        track:Stop()
                        track:Destroy()
                    end
                    animator:Destroy()
                end
                
                humanoid.WalkSpeed = 0
                humanoid.JumpPower = 0
                humanoid.AutoRotate = false
                humanoid.PlatformStand = true
            end
            
            for _, part in pairs(zombie:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.Anchored = true
                    part.CanCollide = false
                    part.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                    part.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                end
            end
            
            for _, obj in pairs(zombie:GetDescendants()) do
                if obj:IsA("Motor6D") or obj:IsA("Weld") or obj:IsA("WeldConstraint") then
                    obj:Destroy()
                end
            end
        end
        
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj:IsA("BodyMover") or obj:IsA("BodyGyro") or obj:IsA("BodyPosition") or 
               obj:IsA("BodyVelocity") or obj:IsA("BodyAngularVelocity") or obj:IsA("BodyForce") then
                obj:Destroy()
            end
        end
        
    else
        for _, zombie in pairs(ZombiesFolder:GetChildren()) do
            local humanoid = zombie:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = 16
                humanoid.JumpPower = 50
                humanoid.AutoRotate = true
                humanoid.PlatformStand = false
            end
            
            for _, part in pairs(zombie:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.Anchored = false
                    part.CanCollide = true
                end
            end
        end
        
        for _, zombie in pairs(ServerZombies:GetChildren()) do
            local humanoid = zombie:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = 16
                humanoid.JumpPower = 50
                humanoid.AutoRotate = true
                humanoid.PlatformStand = false
            end
            
            for _, part in pairs(zombie:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.Anchored = false
                    part.CanCollide = true
                end
            end
        end
    end
end

local function toggleLowGraphics(enabled)
    local Lighting = game:GetService("Lighting")
    local Terrain = workspace.Terrain
    
    if enabled then
        settings().Rendering.QualityLevel = 1
        settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level04
        
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 100
        Lighting.Brightness = 2
        
        for _, effect in pairs(Lighting:GetChildren()) do
            if effect:IsA("PostEffect") then
                effect.Enabled = false
            end
        end
        
        Terrain.WaterWaveSize = 0
        Terrain.WaterWaveSpeed = 0
        Terrain.WaterReflectance = 0
        Terrain.WaterTransparency = 0
        Terrain.Decoration = false
        
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj:IsA("ParticleEmitter") or obj:IsA("Fire") or obj:IsA("Smoke") or obj:IsA("Sparkles") then
                obj.Enabled = false
            elseif obj:IsA("Decal") or obj:IsA("Texture") then
                obj.Transparency = 1
            elseif obj:IsA("SurfaceGui") or obj:IsA("BillboardGui") then
                obj.Enabled = false
            end
        end
        
        for _, zombie in pairs(ZombiesFolder:GetChildren()) do
            for _, gui in pairs(zombie:GetDescendants()) do
                if gui:IsA("BillboardGui") or gui:IsA("SurfaceGui") then
                    gui.Enabled = false
                end
            end
        end
        
        for _, zombie in pairs(ServerZombies:GetChildren()) do
            for _, gui in pairs(zombie:GetDescendants()) do
                if gui:IsA("BillboardGui") or gui:IsA("SurfaceGui") then
                    gui.Enabled = false
                end
            end
        end
        
        Camera.MaxAxisFieldOfView = 70
        
    else
        settings().Rendering.QualityLevel = Enum.QualityLevel.Automatic
        settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level01
        
        Lighting.GlobalShadows = true
        Lighting.FogEnd = 100000
        Lighting.Brightness = 1
        
        for _, effect in pairs(Lighting:GetChildren()) do
            if effect:IsA("PostEffect") then
                effect.Enabled = true
            end
        end
        
        Terrain.WaterWaveSize = 0.05
        Terrain.WaterWaveSpeed = 10
        Terrain.WaterReflectance = 1
        Terrain.WaterTransparency = 0.3
        Terrain.Decoration = true
        
        Camera.MaxAxisFieldOfView = 120
    end
end

local function hasLineOfSight(fromPos, toPos)
    if not isWallCheckEnabled then return true end
    
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {player.Character, ZombiesFolder, ServerZombies}
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist
    rayParams.IgnoreWater = true
    
    local direction = (toPos - fromPos)
    local rayResult = workspace:Raycast(fromPos, direction, rayParams)
    
    return rayResult == nil
end

local function isZombieValid(zombieClient)
    if not zombieClient or not zombieClient.Parent or zombieClient.Parent ~= ZombiesFolder then return false end
    local hitbox = zombieClient:FindFirstChild(TARGET_PART_NAME)
    if not hitbox then return false end
    local hum, root, serverModel = getServerData(zombieClient)
    if not hum or hum.Health <= 0 or not root then return false end
    if serverModel:GetAttribute("Dead") or serverModel:GetAttribute("Ragdoll") then return false end
    return true
end

local lastTargetUpdate = 0
local targetUpdateRate = 0.1

local function getValidTarget()
    local currentTime = tick()
    if currentTime - lastTargetUpdate < targetUpdateRate then
        if currentLockedTarget and isZombieValid(currentLockedTarget.Parent) then
            return currentLockedTarget
        end
    end
    lastTargetUpdate = currentTime
    
    if priorityMode == "boss" or isBossRound then
        local boss = findBoss()
        if boss then
            currentLockedTarget = boss
            targetLockTime = currentTime
            return boss
        end
    end
    
    if currentLockedTarget and isZombieValid(currentLockedTarget.Parent) then
        if currentTime - targetLockTime < stickyTime then
            return currentLockedTarget
        end
    end
    
    local bestTarget = nil
    local bestVal = (priorityMode == "hp") and 0 or math.huge
    local char = player.Character
    local pRoot = char and char:FindFirstChild("HumanoidRootPart")
    if not pRoot then return nil end

    for _, zombie in pairs(ZombiesFolder:GetChildren()) do
        if isZombieValid(zombie) then
            local hitbox = zombie:FindFirstChild(TARGET_PART_NAME)
            local hum = getServerData(zombie)
            if hitbox and hum then
                local dist = (pRoot.Position - hitbox.Position).Magnitude
                
                if dist <= maxLockDistance then
                    if priorityMode == "hp" then
                        if hum.Health > bestVal then
                            bestVal = hum.Health
                            bestTarget = hitbox
                        end
                    elseif priorityMode == "closest" then
                        if dist < bestVal then
                            bestVal = dist
                            bestTarget = hitbox
                        end
                    end
                end
            end
        end
    end
    
    if bestTarget and bestTarget ~= currentLockedTarget then
        targetLockTime = currentTime
    end
    
    currentLockedTarget = bestTarget
    return bestTarget
end

local lastShootTime = 0
local shootDelay = 0.15

local VirtualInputManager = game:GetService("VirtualInputManager")

local function performAutoShoot()
    if not isAutoShootEnabled then return end
    if not (isLockOnActive or isUndergroundCameraLock) then return end
    if not currentLockedTarget then return end
    
    local currentTime = tick()
    if currentTime - lastShootTime < shootDelay then return end
    
    -- MÉTODO 1: Tenta mouse1click primeiro
    local success1 = pcall(function()
        mouse1click()
    end)
    
    -- MÉTODO 2: Se não funcionar, tenta VirtualInputManager
    if not success1 then
        pcall(function()
            local mouse = player:GetMouse()
            VirtualInputManager:SendMouseButtonEvent(mouse.X, mouse.Y, 0, true, game, 0)
            task.wait(0.05)
            VirtualInputManager:SendMouseButtonEvent(mouse.X, mouse.Y, 0, false, game, 0)
        end)
    end
    
    -- MÉTODO 3: Fallback para mouse1press/release
    pcall(function()
        mouse1press()
        task.wait(0.05)
        mouse1release()
    end)
    
    lastShootTime = currentTime
end

local function createStrictToggle(parent, text, pos, default, callback)
    local frame = Instance.new("Frame", parent)
    frame.Size = UDim2.new(1, 0, 0, 30); frame.Position = pos; frame.BackgroundTransparency = 1
    local lbl = Instance.new("TextLabel", frame)
    lbl.Size = UDim2.new(0, 120, 1, 0); lbl.Text = text:lower(); lbl.TextColor3 = Color3.fromRGB(180, 180, 180); lbl.Font = Enum.Font.Gotham; lbl.TextSize = 12; lbl.BackgroundTransparency = 1; lbl.TextXAlignment = Enum.TextXAlignment.Left
    local bg = Instance.new("Frame", frame)
    bg.Size = UDim2.new(0, 34, 0, 16); bg.Position = UDim2.new(1, -34, 0.5, -8); bg.BackgroundColor3 = Color3.fromRGB(20, 20, 20); bg.BorderSizePixel = 1; bg.BorderColor3 = Color3.fromRGB(50, 50, 50)
    local box = Instance.new("Frame", bg)
    box.Size = UDim2.new(0, 8, 0, 8); box.Position = default and UDim2.new(1, -11, 0.5, -4) or UDim2.new(0, 3, 0.5, -4); box.BackgroundColor3 = default and Color3.fromRGB(200, 200, 200) or Color3.fromRGB(60, 60, 60); box.BorderSizePixel = 0
    local btn = Instance.new("TextButton", bg)
    btn.Size = UDim2.new(1, 0, 1, 0); btn.BackgroundTransparency = 1; btn.Text = ""
    btn.MouseButton1Click:Connect(function()
        default = not default
        box.Position = default and UDim2.new(1, -11, 0.5, -4) or UDim2.new(0, 3, 0.5, -4)
        box.BackgroundColor3 = default and Color3.fromRGB(200, 200, 200) or Color3.fromRGB(60, 60, 60)
        callback(default)
    end)
end

local function createStrictSlider(parent, text, pos, minV, maxV, default, callback)
    local frame = Instance.new("Frame", parent)
    frame.Size = UDim2.new(1, 0, 0, 45); frame.Position = pos; frame.BackgroundTransparency = 1
    local lbl = Instance.new("TextLabel", frame)
    lbl.Size = UDim2.new(1, 0, 0, 15); lbl.Text = text:lower(); lbl.TextColor3 = Color3.fromRGB(130, 130, 130); lbl.Font = Enum.Font.Gotham; lbl.TextSize = 11; lbl.TextXAlignment = Enum.TextXAlignment.Left; lbl.BackgroundTransparency = 1
    local sBack = Instance.new("Frame", frame)
    sBack.Size = UDim2.new(1, -60, 0, 1); sBack.Position = UDim2.new(0, 0, 0, 30); sBack.BackgroundColor3 = Color3.fromRGB(50, 50, 50); sBack.BorderSizePixel = 0
    local sBtn = Instance.new("Frame", sBack)
    sBtn.Size = UDim2.new(0, 2, 0, 10); sBtn.Position = UDim2.new((default - minV)/(maxV - minV), -1, 0.5, -5); sBtn.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
    local input = Instance.new("TextBox", frame)
    input.Size = UDim2.new(0, 50, 0, 20); input.Position = UDim2.new(1, -50, 0, 21); input.BackgroundColor3 = Color3.fromRGB(10, 10, 10); input.BorderSizePixel = 1; input.BorderColor3 = Color3.fromRGB(40, 40, 40); input.Text = tostring(default); input.TextColor3 = Color3.new(1, 1, 1); input.Font = Enum.Font.Code; input.TextSize = 11
    local function update(val)
        val = math.clamp(math.round(val * 100) / 100, minV, maxV); input.Text = tostring(val); sBtn.Position = UDim2.new((val - minV)/(maxV - minV), -1, 0.5, -5); callback(val)
    end
    local dragBtn = Instance.new("TextButton", sBack)
    dragBtn.Size = UDim2.new(1, 20, 1, 30); dragBtn.Position = UDim2.new(0, -10, 0, -15); dragBtn.BackgroundTransparency = 1; dragBtn.Text = ""
    local dragging = false
    dragBtn.MouseButton1Down:Connect(function() dragging = true end)
    UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
    UserInputService.InputChanged:Connect(function(i)
        if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
            local rel = math.clamp((i.Position.X - sBack.AbsolutePosition.X) / sBack.AbsoluteSize.X, 0, 1)
            update(minV + (maxV - minV) * rel)
        end
    end)
    input.FocusLost:Connect(function() update(tonumber(input.Text) or default) end)
end

-- ==================== CRIAR GUI ====================

local screenGui = Instance.new("ScreenGui", player.PlayerGui)
screenGui.Name = "autosolver_euler"
local header = Instance.new("Frame", screenGui)
header.Size = UDim2.new(0, 340, 0, 35); header.Position = UDim2.new(0.5, -170, 0.3, 0); header.BackgroundColor3 = Color3.fromRGB(30, 30, 30); header.BorderSizePixel = 0; header.Active = true; header.Draggable = true
local headerTxt = Instance.new("TextLabel", header)
headerTxt.Size = UDim2.new(1, -70, 1, 0); headerTxt.Position = UDim2.new(0, 10, 0, 0); headerTxt.Text = "zombie rng | dc: Grz1n"; headerTxt.TextColor3 = Color3.new(1, 1, 1); headerTxt.Font = Enum.Font.GothamBold; headerTxt.TextSize = 13; headerTxt.BackgroundTransparency = 1; headerTxt.TextXAlignment = Enum.TextXAlignment.Left
local mainBody = Instance.new("Frame", header)
mainBody.Size = UDim2.new(1, 0, 0, 470); mainBody.Position = UDim2.new(0, 0, 1, 1); mainBody.BackgroundColor3 = Color3.fromRGB(0, 0, 0); mainBody.BorderSizePixel = 0

-- BOTÃO X REMOVIDO PARA EVITAR FECHAR ACIDENTALMENTE

local minimizeBtn = Instance.new("TextButton", header)
minimizeBtn.Size = UDim2.new(0, 25, 0, 25); minimizeBtn.Position = UDim2.new(1, -30, 0, 5); minimizeBtn.BackgroundColor3 = Color3.fromRGB(55, 55, 55); minimizeBtn.BorderSizePixel = 0; minimizeBtn.Text = "-"; minimizeBtn.TextColor3 = Color3.new(1, 1, 1); minimizeBtn.Font = Enum.Font.GothamBold; minimizeBtn.TextSize = 18; minimizeBtn.ZIndex = 10
minimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    mainBody.Visible = not isMinimized
    minimizeBtn.Text = isMinimized and "+" or "-"
end)

local sideBar = Instance.new("Frame", mainBody)
sideBar.Size = UDim2.new(0, 80, 1, 0); sideBar.BackgroundColor3 = Color3.fromRGB(10, 10, 10); sideBar.BorderSizePixel = 0

local autoFarmTabBtn = Instance.new("TextButton", sideBar)
autoFarmTabBtn.Size = UDim2.new(1, 0, 0, 45); autoFarmTabBtn.Text = "autofarm"; autoFarmTabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20); autoFarmTabBtn.TextColor3 = Color3.new(1, 1, 1); autoFarmTabBtn.Font = Enum.Font.GothamBold; autoFarmTabBtn.BorderSizePixel = 0; autoFarmTabBtn.TextSize = 12

local combatTabBtn = Instance.new("TextButton", sideBar)
combatTabBtn.Size = UDim2.new(1, 0, 0, 45); combatTabBtn.Position = UDim2.new(0, 0, 0, 45); combatTabBtn.Text = "combat"; combatTabBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0); combatTabBtn.TextColor3 = Color3.new(0.5, 0.5, 0.5); combatTabBtn.Font = Enum.Font.GothamBold; combatTabBtn.BorderSizePixel = 0; combatTabBtn.TextSize = 12

local visualTabBtn = Instance.new("TextButton", sideBar)
visualTabBtn.Size = UDim2.new(1, 0, 0, 45); visualTabBtn.Position = UDim2.new(0, 0, 0, 90); visualTabBtn.Text = "visuals"; visualTabBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0); visualTabBtn.TextColor3 = Color3.new(0.5, 0.5, 0.5); visualTabBtn.Font = Enum.Font.GothamBold; visualTabBtn.BorderSizePixel = 0; visualTabBtn.TextSize = 12

local explorerTabBtn = Instance.new("TextButton", sideBar)
explorerTabBtn.Size = UDim2.new(1, 0, 0, 45); explorerTabBtn.Position = UDim2.new(0, 0, 0, 135); explorerTabBtn.Text = "explorer"; explorerTabBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0); explorerTabBtn.TextColor3 = Color3.new(0.5, 0.5, 0.5); explorerTabBtn.Font = Enum.Font.GothamBold; explorerTabBtn.BorderSizePixel = 0; explorerTabBtn.TextSize = 12

local autoFarmFrame = Instance.new("Frame", mainBody)
autoFarmFrame.Size = UDim2.new(1, -100, 1, -20); autoFarmFrame.Position = UDim2.new(0, 90, 0, 10); autoFarmFrame.BackgroundTransparency = 1

local combatFrame = Instance.new("Frame", mainBody)
combatFrame.Size = UDim2.new(1, -100, 1, -20); combatFrame.Position = UDim2.new(0, 90, 0, 10); combatFrame.BackgroundTransparency = 1; combatFrame.Visible = false

local visualFrame = Instance.new("Frame", mainBody)
visualFrame.Size = UDim2.new(1, -100, 1, -20); visualFrame.Position = UDim2.new(0, 90, 0, 10); visualFrame.BackgroundTransparency = 1; visualFrame.Visible = false

-- AUTO FARM TAB
createStrictToggle(autoFarmFrame, "enable auto farm", UDim2.new(0,0,0,0), isAutoFarmEnabled, function(v) 
    isAutoFarmEnabled = v 
    if v then startAutoFarm() else stopAutoFarm() end
end)

createStrictToggle(autoFarmFrame, "boss detection", UDim2.new(0,0,0,35), isBossDetectionEnabled, function(v) isBossDetectionEnabled = v end)
createStrictToggle(autoFarmFrame, "auto collect drops", UDim2.new(0,0,0,70), isAutoCollectEnabled, function(v) isAutoCollectEnabled = v end)
createStrictSlider(autoFarmFrame, "magnet range", UDim2.new(0,0,0,105), 10, 500, magnetRange, function(v) magnetRange = v end)
createStrictToggle(autoFarmFrame, "infinite shot (no wall)", UDim2.new(0,0,0,160), isInfiniteShotEnabled, function(v) 
    isInfiniteShotEnabled = v 
    if v then
        enableInfiniteShot()
    else
        isWallCheckEnabled = true
        maxLockDistance = 50
    end
end)
createStrictSlider(autoFarmFrame, "safe underground depth", UDim2.new(0,0,0,195), 5, 30, safeUndergroundDepth, function(v) safeUndergroundDepth = v end)

-- Combat Tab
createStrictToggle(combatFrame, "camera lock (normal)", UDim2.new(0,0,0,0), isLockOnActive, function(v) 
    isLockOnActive = v 
    if v then isUndergroundCameraLock = false end
end)

createStrictToggle(combatFrame, "camera lock (underground)", UDim2.new(0,0,0,35), isUndergroundCameraLock, function(v) 
    isUndergroundCameraLock = v 
    if v then isLockOnActive = false end
end)

local bindBtn = Instance.new("TextButton", combatFrame)
bindBtn.Size = UDim2.new(1, 0, 0, 30); bindBtn.Position = UDim2.new(0,0,0,70); bindBtn.BackgroundColor3 = Color3.fromRGB(20,20,20); bindBtn.Text = "keybind: " .. lockKey.Name:lower(); bindBtn.TextColor3 = Color3.new(1,1,1); bindBtn.Font = Enum.Font.Code; bindBtn.TextSize = 11; bindBtn.BorderSizePixel = 1; bindBtn.BorderColor3 = Color3.fromRGB(50,50,50)
bindBtn.MouseButton1Click:Connect(function() isBinding = true; bindBtn.Text = "press any key..." end)

createStrictSlider(combatFrame, "lock smoothness", UDim2.new(0,0,0,110), 0.05, 1, lockSmoothness, function(v) lockSmoothness = v end)
createStrictSlider(combatFrame, "max lock distance", UDim2.new(0,0,0,165), 1, 500, maxLockDistance, function(v) maxLockDistance = v end)
createStrictToggle(combatFrame, "auto shoot", UDim2.new(0,0,0,220), isAutoShootEnabled, function(v) isAutoShootEnabled = v end)
createStrictSlider(combatFrame, "shoot speed", UDim2.new(0,0,0,255), 0.05, 0.5, shootSpeed, function(v) shootDelay = v end)
createStrictSlider(combatFrame, "sticky target", UDim2.new(0,0,0,310), 0.5, 5, stickyTime, function(v) stickyTime = v end)

-- Visual Tab
createStrictToggle(visualFrame, "hitbox outline", UDim2.new(0,0,0,0), isShowHitboxEnabled, function(v) isShowHitboxEnabled = v end)
createStrictToggle(visualFrame, "low graphics", UDim2.new(0,0,0,35), isLowGraphicsEnabled, function(v) 
    isLowGraphicsEnabled = v 
    toggleLowGraphics(v)
end)
createStrictToggle(visualFrame, "reduce motion", UDim2.new(0,0,0,70), isReduceMotionEnabled, function(v) 
    isReduceMotionEnabled = v 
    toggleReduceMotion(v)
end)
createStrictToggle(visualFrame, "fly", UDim2.new(0,0,0,105), isFlyEnabled, function(v) 
    isFlyEnabled = v 
    toggleFly(v)
end)
createStrictSlider(visualFrame, "fly speed", UDim2.new(0,0,0,140), 10, 200, flySpeed, function(v) flySpeed = v end)
createStrictToggle(visualFrame, "noclip", UDim2.new(0,0,0,195), isNoclipEnabled, function(v) 
    isNoclipEnabled = v 
    toggleNoclip(v)
end)
createStrictToggle(visualFrame, "underground", UDim2.new(0,0,0,230), isUndergroundEnabled, function(v) 
    isUndergroundEnabled = v 
    toggleUnderground(v)
end)
createStrictSlider(visualFrame, "underground depth", UDim2.new(0,0,0,265), 5, 50, undergroundDepth, function(v) undergroundDepth = v end)

-- TAB SWITCHING
local function switchTab(target)
    autoFarmFrame.Visible = (target == "autofarm")
    combatFrame.Visible = (target == "combat")
    visualFrame.Visible = (target == "visual")
    
    autoFarmTabBtn.BackgroundColor3 = (target == "autofarm") and Color3.fromRGB(20, 20, 20) or Color3.fromRGB(0, 0, 0)
    combatTabBtn.BackgroundColor3 = (target == "combat") and Color3.fromRGB(20, 20, 20) or Color3.fromRGB(0, 0, 0)
    visualTabBtn.BackgroundColor3 = (target == "visual") and Color3.fromRGB(20, 20, 20) or Color3.fromRGB(0, 0, 0)
    
    autoFarmTabBtn.TextColor3 = (target == "autofarm") and Color3.new(1, 1, 1) or Color3.new(0.5, 0.5, 0.5)
    combatTabBtn.TextColor3 = (target == "combat") and Color3.new(1, 1, 1) or Color3.new(0.5, 0.5, 0.5)
    visualTabBtn.TextColor3 = (target == "visual") and Color3.new(1, 1, 1) or Color3.new(0.5, 0.5, 0.5)
end

autoFarmTabBtn.MouseButton1Click:Connect(function() switchTab("autofarm") end)
combatTabBtn.MouseButton1Click:Connect(function() switchTab("combat") end)
visualTabBtn.MouseButton1Click:Connect(function() switchTab("visual") end)
explorerTabBtn.MouseButton1Click:Connect(function() createObjectExplorer() end)

RunService.Heartbeat:Connect(function()
    if isAutoShootEnabled and (isLockOnActive or isUndergroundCameraLock) and currentLockedTarget then
        performAutoShoot()
    end
end)

local lastVisualUpdate = 0
local visualUpdateRate = 0.2

RunService.RenderStepped:Connect(function(dt)
    -- CÂMERA LOCK COM MODO UNDERGROUND
    if isLockOnActive or isUndergroundCameraLock then
        local target = getValidTarget()
        if target then
            local char = player.Character
            local root = char and char:FindFirstChild("HumanoidRootPart")
            
            if isUndergroundCameraLock and root then
                -- MODO UNDERGROUND: Mira de baixo para cima
                local targetPos = target.Position
                local undergroundPos = root.Position - Vector3.new(0, undergroundDepth, 0)
                local lookDirection = (targetPos - undergroundPos).Unit
                local targetRotation = CFrame.lookAt(Camera.CFrame.Position, Camera.CFrame.Position + lookDirection).Rotation
                Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position) * targetRotation, 1 - lockSmoothness)
            elseif isLockOnActive then
                -- MODO NORMAL: Mira direta
                local targetPos = target.Position
                local targetRotation = CFrame.lookAt(Camera.CFrame.Position, targetPos).Rotation
                Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position) * targetRotation, 1 - lockSmoothness)
            end
        end
    end
    
    local currentTime = tick()
    if currentTime - lastVisualUpdate >= visualUpdateRate then
        lastVisualUpdate = currentTime
        
        for _, zombie in pairs(ZombiesFolder:GetChildren()) do
            local hitbox = zombie:FindFirstChild(TARGET_PART_NAME)
            if hitbox then
                local box = hitbox:FindFirstChild("HitboxOutline")
                if isShowHitboxEnabled then
                    if not box then
                        box = Instance.new("SelectionBox", hitbox)
                        box.Name = "HitboxOutline"
                        box.Adornee = hitbox
                        box.Color3 = Color3.new(1, 0, 0)
                        box.LineThickness = 0.05
                        box.SurfaceTransparency = 0.8
                    end
                elseif box then 
                    box:Destroy() 
                end
            end
        end
    end
end)

UserInputService.InputBegan:Connect(function(input, gpe)
    if isBinding and input.UserInputType == Enum.UserInputType.Keyboard then
        lockKey = input.KeyCode
        bindBtn.Text = "keybind: " .. lockKey.Name:lower()
        isBinding = false
        return
    end
    if not gpe then
        if input.KeyCode == Enum.KeyCode.Insert then 
            header.Visible = not header.Visible
        elseif input.KeyCode == lockKey then 
            -- TOGGLE PARA QUALQUER MODO DE LOCK ATIVO
            if isLockOnActive then
                isLockOnActive = false
            elseif isUndergroundCameraLock then
                isUndergroundCameraLock = false
            else
                isLockOnActive = true
            end
        end
    end
end)

print("[ZOMBIE RNG] Auto Farm System carregado!")
print("[ZOMBIE RNG] Pressione INSERT para abrir/fechar o menu")
print("[ZOMBIE RNG] Pressione T para pausar/retomar Camera Lock")
print("[ZOMBIE RNG] NOVO: Camera Lock (Underground) - Atira de baixo para cima!")
print("[ZOMBIE RNG] Auto-shoot só funciona quando o jogo está focado")
print("[ZOMBIE RNG] Use a aba EXPLORER para descobrir nomes de objetos no jogo")
